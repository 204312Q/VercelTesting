// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================================= ENUMS =================================================

enum AdminRole {
  SUPERADMIN
  STAFF
}

enum ProductType {
  PACKAGE
  ADDON
  GIFTBOX
}

enum OptionType {
  PACKAGE_DURATION // 7/14/21/28 days
  ADDON_SERVING // 1/3/5 servings
  ADDON_BUNDLE // Comforting Set
  PARTNER_BUNDLE // Any partner-specific bundle
}

enum MealPortion {
  SINGLE
  DUAL
  TRIAL
}

enum MealSession {
  LUNCH
  DINNER
}

enum InputType {
  EDD
  CONFIRMED_DATE
}

enum DiscountType {
  PERCENT
  FIXED
}

enum PaymentMethod {
  STRIPE // Card
  PAYNOW // PayNow
  MANUAL // Manual bank transfer
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum OrderStatus {
  UNFULFILLED // just created (paid), waiting for sales/admin to ack
  ACKNOWLEDGED // sales or admin have reviewed 
  IN_PROGRESS // start date have been set, meal deliveries have begun
  CANCELLED // order was called off
}

enum PaymentPurpose {
  FULL // For full payment
  DEPOSIT // For partial payment 
  BALANCE // For payment left to paid
  ADJUSTMENT // For order upgrade purpose
  REFUND_PARTIAL // For refund purposes
}

enum PaymentKind {
  CHARGE
  REFUND
}

enum ExportStatus {
  PENDING // not sent yet
  SENT // pushed to Dynamics OK
  FAILED // push failed; retry later
}

enum RiceOption {
  WHITE
  BROWN
  NO_PREF
}

// ================================================= Sprint 1 =================================================

model Admin {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  passwordHash String // store the hashed password here
  role         AdminRole
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  banners Banner[] //RR
}

model Banner {
  id          String   @id @default(cuid())
  title       String?
  publicId    String   @unique // Cloudinary public id
  imageUrl    String
  linkUrl     String?
  isActive    Boolean  @default(true)
  sortOrder   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   Admin?   @relation(fields: [createdById], references: [id])
  createdById String?
}

// ================================================= Sprint 2=================================================
// Product

model Product {
  product_id  Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  type        ProductType
  price       Decimal     @db.Decimal(12, 2)
  visible     Boolean     @default(true)
  created_by  String?
  created_at  DateTime    @default(now())
  updated_by  String?
  updated_at  DateTime    @updatedAt

  // Cloudinary
  imageUrl      String? // Cloudinary secure_url
  imagePublicId String? // Cloudinary public_id (handy for replace/delete)

  // Which package → add-on links exist
  components    ProductComponent[] @relation("ParentProduct")
  partOfBundles ProductComponent[] @relation("ComponentProduct")

  // Options for this product
  options ProductOption[]

  // RR
  orderItems      OrderItem[]
  ordersAsPackage Order[]     @relation("PackageProduct")

  @@index([type, visible])
}

model ProductComponent {
  id           Int     @id @default(autoincrement())
  parent_id    Int
  component_id Int
  parent       Product @relation("ParentProduct", fields: [parent_id], references: [product_id])
  component    Product @relation("ComponentProduct", fields: [component_id], references: [product_id])
}

model ProductOption {
  id        Int        @id @default(autoincrement())
  productId Int
  type      OptionType
  label     String
  value     Int
  price     Decimal    @db.Decimal(12, 2)

  product               Product @relation(fields: [productId], references: [product_id])
  ordersAsProductOption Order[] @relation("OrderProductOption")

  orderItems OrderItem[]
}

// ================================================== Order ==================================================

model Order {
  id              Int          @id @default(autoincrement())
  productId       Int
  portion         MealPortion // Single / Double / Trial
  session         MealSession? // Lunch / Dinner / null
  input_type      InputType // Enum: CONFIRMED_DATE or EDD
  input_date      DateTime // Date that customer select (EDD/confirmed start date)
  productOptionId Int

  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  status     OrderStatus @default(UNFULFILLED)

  customerId    Int? // optional until payment completes
  subtotal      Decimal? @db.Decimal(12, 2)
  discount      Decimal? @db.Decimal(12, 2)
  total         Decimal? @db.Decimal(12, 2)
  gst_amount    Decimal? @db.Decimal(12, 2)
  amount_paid   Decimal  @default(0) @db.Decimal(12, 2) // sum(charges) - sum(refunds)
  is_fully_paid Boolean  @default(false)

  delivery    OrderDelivery? // Snapshots for delivery details during order progress
  paymentPlan String         @default("FULL") // FULL OR PARTIAL

  product       Product       @relation("PackageProduct", fields: [productId], references: [product_id])
  customer      Customer?     @relation(fields: [customerId], references: [customer_id])
  productOption ProductOption @relation("OrderProductOption", fields: [productOptionId], references: [id])
  riceOption    RiceOption    @default(NO_PREF)

  items             OrderItem[]
  requests          OrderRequest[] // Preset special request
  notes             OrderNote? // Customer remarks
  payment           Payment[]
  appliedPromotions AppliedOrderPromotion[]
  OrderConfirmation OrderConfirmation?
}

model OrderDelivery {
  id        Int    @id @default(autoincrement())
  orderId   Int    @unique
  full_name String
  phone     String
  email     String

  address_line String
  floor        String?
  unit         String?
  postal_code  String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model OrderItem {
  order_item_id           Int     @id @default(autoincrement()) // PK (auto increment)
  orderId                 Int
  product_id              Int // FK - tells us which product was ordered
  optionId                Int?
  quantity                Int // Quantity of the item
  price                   Decimal @db.Decimal(12, 2) // Price of the item
  special_request_options Json? // Optional structured exclusion list
  special_request_notes   String? // Additional note from customer

  order   Order          @relation(fields: [orderId], references: [id])
  product Product        @relation(fields: [product_id], references: [product_id])
  option  ProductOption? @relation(fields: [optionId], references: [id])
}

// Request belong to that order
model OrderRequest {
  id               Int     @id @default(autoincrement())
  orderId          Int
  specialRequestId Int?
  value            Boolean // checked or not

  order          Order           @relation(fields: [orderId], references: [id])
  specialRequest SpecialRequest? @relation(fields: [specialRequestId], references: [id], onDelete: Cascade)

  @@unique([orderId, specialRequestId])
}

// Customer remark notes
model OrderNote {
  id      Int    @id @default(autoincrement())
  orderId Int    @unique
  text    String

  order Order @relation(fields: [orderId], references: [id])
}

// Preset checkboxes
model SpecialRequest {
  id        Int      @id @default(autoincrement())
  value     String   @unique
  label     String // Customer Facing Text
  active    Boolean  @default(true)
  sort      Int? // optional: for display order
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Reverse relation
  orderRequests OrderRequest[]
}

model OrderConfirmation {
  id              Int          @id @default(autoincrement())
  order_id        Int          @unique
  payload         Json // denormalized order snapshot for emails/admin/D365
  export_status   ExportStatus @default(PENDING)
  export_attempts Int          @default(0)
  last_error      String?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  order Order @relation(fields: [order_id], references: [id], onDelete: Cascade)
}

// ================================================== Promotion ==================================================

model Promotion {
  promotion_id   Int          @id @default(autoincrement())
  promotion_code String       @unique
  discount_type  DiscountType
  discount_value Decimal      @db.Decimal(12, 2) // e.g. 5.00 means “5%” if PERCENT, or “$5.00” if FIXED
  extra_rules    Json? // any JSON flags or conditions you might need later
  starts_at      DateTime
  ends_at        DateTime
  max_uses       Int? // null = unlimited
  created_by     String?
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt

  appliedToOrders AppliedOrderPromotion[]
}

model AppliedOrderPromotion {
  id              Int      @id @default(autoincrement())
  promotion_id    Int
  order_id        Int
  discount_amount Decimal  @db.Decimal(12, 2) // the $-amount you actually subtracted
  applied_by      String
  applied_at      DateTime @default(now())

  promotion Promotion @relation(fields: [promotion_id], references: [promotion_id])
  order     Order     @relation(fields: [order_id], references: [id])

  @@unique([order_id]) // Allow one order-level discount per order
}

// ================================================== Payment ==================================================

model Payment {
  payment_id               Int            @id @default(autoincrement())
  order_id                 Int
  method                   PaymentMethod
  purpose                  PaymentPurpose
  kind                     PaymentKind    @default(CHARGE) // CHARGE or REFUND
  status                   PaymentStatus  @default(PENDING)
  amount                   Decimal        @db.Decimal(12, 2) // amount actually charged
  stripe_session_id        String?
  stripe_payment_intent_id String?
  reference                String?
  paid_at                  DateTime? // when gateway confirmed
  note                     String? // admin notes, if any
  created_at               DateTime       @default(now())
  updated_at               DateTime       @updatedAt

  order Order @relation(fields: [order_id], references: [id])

  @@index([order_id])
}

// ================================================== Customer ==================================================

model Customer {
  customer_id      Int      @id @default(autoincrement())
  name             String
  email            String
  phone            String
  address          String
  marketing_opt_in Boolean
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  orders Order[]

  // Enforce uniqueness for identity verification
  @@unique([phone])
  @@unique([email])
}
